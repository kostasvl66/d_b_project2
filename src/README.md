# Υλοποίηση των BPlus συναρτήσεων

- Υλοποιήσεις από Εμμανουήλ-Ταξιάρχη Οζίνη (sdi2300147): `bplus_create_file`, `bplus_record_insert`
- Υλοποιήσεις από Κωνσταντίνο Γεώργιο Βλαζάκη (sdi2300017): `bplus_open_file`, `bplus_close_file`, `bplus_record_find`

## bplus_create_file
Για την υλοποίηση της `bplus_create_file`, ανοίγει το αρχείο, δημιουργείται το block 0 που θα περιέχει τα metadata, δίνονται τιμές στα metadata και ξανακλείνει το αρχείο.

## bplus_record_insert
Η συνάρτηση αυτή αναλαμβάνει πολύ μεγάλο όγκο λειτουργιών και ήταν αναγκαία η δημιουργία πολλών βοηθητικών συναρτήσεων (δηλωμένες **μόνο** στο bplus_file_funcs.c και όχι στην βιβλιοθήκη .h), έτσι ώστε να μπορεί να δομηθεί πιο οργανωμένα. Οι συναρτήσεις αυτές επικοινωνούν μέσω ενός αντικειμένου context το οποίο κρατά όλες τις μεταβλητές που μοιράζονται οι βοηθητικές συναρτήσεις. Στην συνάρτηση bplus_record_insert (δηλαδή κυρίως στις επιμέρους βοηθητικές συναρτήσεις της), χρησιμοποιούνται και οι διάφορες βοηθητικές συναρτήσεις των data_block και index_block.

Κατά την εκτέλεση της `bplus_record_insert` σε μεγάλα δέντρα εμφανίζεται κάποιες φορές **bug** στην σωστή ενημέρωση της κατάστασης των κόμβων, με αποτέλεσμα σε τέτοιες περιπτώσεις η δομή να μην είναι έγκυρη, με ό,τι αυτό συνεπάγεται. Αυτό συγκεκριμένα παρατηρείται για περίπου 300 εγγραφές και ανω.
Ωστόσο για σχετικά μικρά μεγέθη που η εκτύπωση των κόμβων είναι πρακτική (10 - 20 εγγραφές), η κατάσταση των κόμβων έχει παρατηρηθεί σε πολλές δοκιμές, και τουλάχιστον μέσα σε αυτά τα όρια μεγέθους, η δομή αποθηκεύεται ακριβώς όπως θα έπρεπε.

## bplus_find_record
Η **bplus_find_record** χρησιμοποιείται για την εύρεση κάποιας εγγραφής στο Β+-Δέντρο, με βάση το κλειδί του.

Τα ορίσματα που λαμβάνει είναι τα εξής:
- **file_desc**: Ο περιγραφέας του **B+-Tree** αρχείου στο οποίο θα εφαρμοστεί αναζήτηση.
- **metadata**: Τα μεταδεδομένα του συγκεκριμένου B+-Δέντρου.
- **key**: Το κλειδί της εγγραφής προς αναζήτηση.
- **out_record**: Δείκτης που οδηγεί σε έναν άλλο δείκτη, ο οποίος με την σειρά του οδηγεί στην **διεύθυνση** της αναζητούμενης εγγραφής στην μνήμη. Η συνάρτηση τον θέτει κατάλληλα ώστε να οδηγεί στην εγγραφή που θα βρεθεί (ή τον θέτει ως NULL εάν δεν βρεθεί).

Υλοποίηση:
- Λαμβάνει τα μεταδεδομένα του B+-Tree αρχείου από το Block 0, και τα αποθηκεύει στον δείκτη "**tree_info**". Δεν χρησιμοποιεί τα μεταδεδομένα που δίνονται μέσω του δείκτη "**metadata**", καθώς εκεί περιέχεται ένα **αντίγραφο** του Block 0, αντί για την **διεύθυνση** του Block 0 στην μνήμη.
- Λαμβάνει το Block Index του Block που αποτελεί την ρίζα του Β+-Δέντρου, μέσα από τα μεταδεδομένα που **παραλήφθηκαν προηγουμένως**.
- Χρησιμοποιεί την βοηθητική συνάρτηση "**tree_search_data_block**", η οποία αποθηκεύει στον δείκτη "**res_block**" την **διεύθυνση** του **Block** δεδομένων στο οποίο πρέπει να βρίσκεται η εγγραφή με το επιθυμητό κλειδί. Επιπλέον, λαμβάνει τα μεταδεδομένα αυτού του Block, μέσω της βοηθητικής συνάρτησης "**data_block_read_header**". Πιο συγκεκριμένα, διαβάζει από τα μεταδεδομένα τον αριθμό εγγραφών που έχουν αποθηκευτεί στο αντίστοιχο Block.
- Τρέχει έναν βρόχο **`for`** **από** το 0 **έως** τον αριθμό των αποθηκευμένων εγγραφών, ο οποίος:
	- Λαμβάνει κάθε εγγραφή αποθηκευμένη στο Block, ελέγχει αν το κλειδί της εγγραφής ταιριάζει με το κλειδί που ψάχνουμε, και αν ναι, θέτει τον δείκτη "**out_record**" ώστε να οδηγεί στην συγκεκριμένη εγγραφή. Εκεί τερματίζει η συνάρτηση επιστρέφοντας την τιμή "**0**", εφόσον έχει πετύχει η εύρεση της αναζητούμενης εγγραφής.
	- Στο τέλος κάθε επανάληψης, ο δείκτης "**rec**", που οδηγεί σε κάθε εγγραφή που ελέγχουμε, πρέπει να εκκαθαριστεί με **`free`** ώστε να μην παραμείνουν δεσμευμένα κομμάτια μνήμης τα οποία δεν χρησιμοποιούνται.
- Τέλος, εάν η συνάρτηση δεν έχει επιστρέψει με τιμή "**0**" μέσω του βρόχου **`for`**, τότε επιστρέφει με τιμή "**-1**", καθώς δεν έχει βρεθεί εγγραφή που να αντιστοιχεί στο κλειδί προς αναζήτηση.
